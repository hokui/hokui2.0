<h1><%= @subject.subject_name %></h1>

<section>
  <h3>シラバス情報</h3>
  <dl class="dl-horizontal">
    <dt>教科名</dt>
    <dd><%= @subject.subject_name %></dd>
    <dt>学期</dt>
    <dd><%= @subject.term.term_name %></dd>
    <dt>責任教員</dt>
    <dd><%= @subject.subject_staff %></dd>
    <dt>シラバス</dt>
    <dd><%= link_to 'シラバスページを表示', '#syllabus', data: { toggle: 'modal' } %></dd>
  </dl>
</section>

<section>
  <h3>資料</h3>

  <section>
    <h4>過去問</h4>
    <%= link_to '新規アップロード', "/study/#{@subject.term_identifier}/#{@subject.subject_identifier}/new_exam_file", class: 'btn btn-primary btn-mini' %>
    <% if @subject.past_exams.any? %>
      <table class="table">
        <tr>
          <th>年度</th>
          <th>回</th>
          <th colspan="3">問題</th>
          <th colspan="3">解答</th>
        </tr>
        <% @subject.past_exams.group(:material_year).map{|obj| obj.material_year}.each.with_index do |year, i| %>
          <% materials = @subject.past_exams.where(material_year: year) %>

          <% rowspan = 0 %>
          <% materials.group(:material_number).map{|obj| obj.material_number}.each do |number| %>
            <% questions = @subject.past_exams.where(material_number: number, material_with_answer: false) %>
            <% answers = @subject.past_exams.where(material_number: number, material_with_answer: true) %>
            <% rowspan += [questions.length, answers.length].max %>
          <% end %>

          <tr>
            <td rowspan="<%= rowspan %>"><%= year %></td>
            <% materials = @subject.past_exams.where(material_year: year) %>
            <% materials.group(:material_number).map{|obj| obj.material_number}.each.with_index do |number, j| %>
              <% questions = @subject.past_exams.where(material_number: number, material_with_answer: false) %>
              <% answers = @subject.past_exams.where(material_number: number, material_with_answer: true) %>
              <% rows = [questions.length, answers.length].max %>
              <%= j != 0 ? raw('<tr>') : '' %>
              <td rowspan="<%= rows %>"><%= number %></td>
              <% rows.times do |k| %>
                <%= k != 0 ? raw('<tr>') : '' %>
                  <td><%= questions[k] ? questions[k].material_file_name : '' %></td><td></td><td></td>
                  <td><%= answers[k] ? answers[k].material_file_name : '' %></td><td></td><td></td>
                </tr>
              <% end %>
            </tr>
          <% end %>
        <% end %>
      </table>
    <% end %>
  </section>

  <section>
    <h4>小テスト</h4>
    <%= link_to '新規アップロード', "/study/#{@subject.term_identifier}/#{@subject.subject_identifier}/new_quiz_file", class: 'btn btn-primary btn-mini' %>
  </section>

  <section>
    <h4>授業資料</h4>
    <%= link_to '新規アップロード', "/study/#{@subject.term_identifier}/#{@subject.subject_identifier}/new_summary_file", class: 'btn btn-primary btn-mini' %>
  </section>

  <section>
    <h4>個人ファイル</h4>
    <%= link_to '新規アップロード', "/study/#{@subject.term_identifier}/#{@subject.subject_identifier}/new_personal_file", class: 'btn btn-primary btn-mini' %>
  </section>
</section>






<!-- modal用シラバスページ -->
<div class="modal hide fade" id="syllabus">
  <div class="modal-body">
    <%= raw(@subject.subject_syllabus_html) %>
  </div>
</div>
